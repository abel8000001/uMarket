<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="uMarket.Pages.ChatPage"
             Title="Chat"
             BackgroundColor="#F2F2F7">

	<Grid RowDefinitions="Auto,*,Auto" RowSpacing="0">
		
		<!-- Top Bar -->
		<Border Grid.Row="0"
                BackgroundColor="White"
                Padding="10,5">
			<Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="10">
				<Button Grid.Column="0"
                        Text="â† Volver"
                        Clicked="BackButton_Clicked"
                        BackgroundColor="Transparent"
                        TextColor="{StaticResource Primary}"
                        FontSize="16"
                        Padding="5"/>

				<Label Grid.Column="1"
                       x:Name="OtherPersonNameLabel"
                       Text="Cargando..."
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Primary}"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       HorizontalTextAlignment="Center"/>

				<Button Grid.Column="2"
                        x:Name="EndChatButton"
                        Text="Finalizar Chat"
                        Clicked="EndChatButton_Clicked"
                        BackgroundColor="#FF3B30"
                        TextColor="White"
                        FontSize="14"
                        Padding="10,5"
                        CornerRadius="6"/>
			</Grid>
		</Border>

		<!-- Messages -->
		<CollectionView Grid.Row="1"
                        x:Name="MessagesCollection"
                        SelectionMode="None"
                        BackgroundColor="#F2F2F7"
                        ItemsUpdatingScrollMode="KeepLastItemInView">
			<CollectionView.ItemTemplate>
				<DataTemplate>
					<Grid Padding="10,3">
						<!-- My Message -->
						<Frame IsVisible="{Binding IsMyMessage}"
                               BackgroundColor="{StaticResource Primary}"
                               CornerRadius="18"
                               Padding="12,8"
                               Margin="60,0,0,0"
                               HorizontalOptions="End"
                               HasShadow="False">
							<StackLayout Spacing="2">
								<Label Text="{Binding Content}"
                                       TextColor="White"
                                       FontSize="16"
                                       LineBreakMode="WordWrap"/>
								<Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                       TextColor="White"
                                       FontSize="11"
                                       Opacity="0.8"
                                       HorizontalOptions="End"/>
							</StackLayout>
						</Frame>

						<!-- Other's Message -->
						<Frame IsVisible="{Binding IsOtherMessage}"
                               BackgroundColor="#E5E5EA"
                               CornerRadius="18"
                               Padding="12,8"
                               Margin="0,0,60,0"
                               HorizontalOptions="Start"
                               HasShadow="False">
							<StackLayout Spacing="2">
								<Label Text="{Binding Content}"
                                       TextColor="Black"
                                       FontSize="16"
                                       LineBreakMode="WordWrap"/>
								<Label Text="{Binding SentAt, StringFormat='{0:HH:mm}'}"
                                       TextColor="Black"
                                       FontSize="11"
                                       Opacity="0.6"
                                       HorizontalOptions="End"/>
							</StackLayout>
						</Frame>
					</Grid>
				</DataTemplate>
			</CollectionView.ItemTemplate>
		</CollectionView>

		<!-- Input Bar -->
		<Border Grid.Row="2"
                BackgroundColor="White"
                Padding="10">
			<Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
				<Border Grid.Column="0"
                        StrokeThickness="1"
                        Stroke="#E5E5EA"
                        BackgroundColor="White"
                        StrokeShape="RoundRectangle 20"
                        Padding="15,10">
					<Entry x:Name="MessageEntry"
                           Placeholder="Escribe un mensaje..."
                           PlaceholderColor="#999999"
                           TextColor="Black"
                           FontSize="16"
                           MaxLength="500"
                           Completed="SendButton_Clicked"/>
				</Border>

				<Button Grid.Column="1"
                        x:Name="SendButton"
                        Text="Enviar"
                        Clicked="SendButton_Clicked"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="20"
                        Padding="20,10"
                        WidthRequest="80"
                        HeightRequest="40"/>
			</Grid>
		</Border>
	</Grid>
</ContentPage>